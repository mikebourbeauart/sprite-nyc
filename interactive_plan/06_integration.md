# 06 — Integration with Existing Pipeline

## Principle: Additive, Not Disruptive

The interactive viewer is a **new entry point** alongside the existing static viewer. The generation pipeline is untouched.

```
Existing pipeline (unchanged):
  plan → render → template → upload → generate → export DZI

New interactive layer (additive):
  DZI tiles ──┐
              ├──► Interactive Viewer (PixiJS)
  scene.json ─┘
```

## Project Structure

```
sprite-nyc/
├── src/sprite_nyc/          ← existing pipeline (unchanged)
├── web/                     ← existing Three.js renderer (unchanged)
├── viewer/                  ← existing static viewer (unchanged)
│
├── interactive/             ← NEW: interactive viewer
│   ├── package.json
│   ├── vite.config.ts
│   ├── index.html
│   ├── src/
│   │   ├── main.ts          ← entry point, PixiJS app setup
│   │   ├── config.ts        ← loads view.json + scene.json
│   │   ├── renderer/
│   │   │   ├── DZITileLoader.ts
│   │   │   ├── SpriteManager.ts
│   │   │   └── Viewport.ts
│   │   ├── simulation/
│   │   │   ├── Simulation.ts       ← main loop
│   │   │   ├── VehicleSystem.ts
│   │   │   ├── PedestrianSystem.ts
│   │   │   ├── TrafficLightSystem.ts
│   │   │   └── SpatialHash.ts
│   │   ├── graph/
│   │   │   ├── RoadGraph.ts
│   │   │   ├── SidewalkGraph.ts
│   │   │   ├── Pathfinding.ts      ← A* implementation
│   │   │   └── types.ts
│   │   ├── sprites/
│   │   │   ├── SpritePool.ts
│   │   │   ├── AnimatedEntity.ts
│   │   │   └── DepthSort.ts
│   │   └── ui/
│   │       ├── Controls.ts         ← speed/density sliders
│   │       ├── InfoPanel.ts        ← building click info
│   │       └── Minimap.ts
│   ├── assets/
│   │   ├── sprites/
│   │   │   ├── vehicles.png        ← sprite sheet
│   │   │   ├── vehicles.json       ← sprite sheet metadata
│   │   │   ├── pedestrians.png
│   │   │   ├── pedestrians.json
│   │   │   └── traffic_lights.png
│   │   └── scene.json              ← pre-processed OSM data
│   └── public/
│       └── tiles/ → symlink to viewer/tiles/  (or copy)
│
├── tools/                    ← NEW: data processing scripts
│   ├── fetch_osm.py
│   ├── project_to_screen.py
│   ├── build_road_graph.py
│   ├── detect_entrances.py
│   └── export_scene.py      ← orchestrator → scene.json
│
└── interactive_plan/         ← this planning folder
```

## Shared Data

### From existing pipeline → interactive viewer

| Data | Source | Format | How it flows |
|------|--------|--------|-------------|
| Tile images | `viewer/tiles/tiles_files/` | DZI PNG pyramid | Loaded directly by DZITileLoader |
| DZI metadata | `viewer/tiles/tiles.dzi` | XML | Parsed at startup for dimensions/levels |
| Map center | `view.json` | JSON | Used for coordinate projection |
| Map bounds | `generation_config.json` | JSON | Defines OSM query bounding box |

### New data (generated by tools/)

| Data | Source | Format |
|------|--------|--------|
| Road graph | OSM → `tools/` | `scene.json` |
| Building footprints | OSM → `tools/` | `scene.json` |
| Sidewalk paths | OSM → `tools/` | `scene.json` |
| POI locations | OSM + `landmarks.json` → `tools/` | `scene.json` |

## Configuration

The interactive viewer reads the same `view.json` as the pipeline, ensuring coordinate consistency:

```typescript
// interactive/src/config.ts
import viewConfig from '../../view.json'

export const MAP_CENTER = viewConfig.center           // { lat, lng }
export const AZIMUTH = viewConfig.azimuth             // -15
export const ELEVATION = viewConfig.elevation         // -45
export const VIEW_HEIGHT = viewConfig.view_height_meters
export const TILE_SIZE = viewConfig.width             // 1024
```

## Build & Dev

```bash
# Interactive viewer
cd interactive && npm install && npm run dev   # Vite dev server, port 3001

# Generate scene data (run once, or when map area changes)
uv run python tools/export_scene.py \
  --config generation_config.json \
  --view view.json \
  --output interactive/assets/scene.json

# Production build
cd interactive && npm run build   # outputs to interactive/dist/
```

## Deployment

The interactive viewer is a static site (HTML + JS + tile images). Deploy the same way as the current viewer — any static file host (Vercel, Netlify, S3, etc.).

Tile images are the heaviest asset (~500MB+ for a large map). Host them on a CDN or serve from the same GCS bucket already used by the pipeline.
